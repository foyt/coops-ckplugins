/*! CKEditor plugin coops-connector - v0.1.2 - 2016-05-30
* https://github.com/foyt/coops-ckplugins
* Copyright (c) 2016 ; Licensed LGPL-v3 */
(function(){DefaultIOHandler=CKEDITOR.tools.createClass({$:function(a){a.on("CoOPS:BeforeSessionStart",function(a){this._useMethodOverride=!!a.data.joinData.extensions["x-http-method-override"]},this)},proto:{get:function(a,b,c){this._doGetRequest(a,b,function(a,b){(200!==a||b)&&(200!==a?c(a,null,b):c(a,JSON.parse(b),null))})},patch:function(a,b,c){this._doJsonPostRequest("PATCH",a,b,c)},_doJsonPostRequest:function(a,b,c,d){var e=JSON.stringify(c);this._doPostRequest(a,b,e,"application/json",function(a,b){if(200!==a||b)try{if(200!==a)d(a,null,b);else{var c=JSON.parse(b);d(a,c,null)}}catch(e){d(a,null,e)}})},_processParameters:function(a){var b="";if(a&&a.length>0)for(var c=0,d=a.length;d>c;c++)c>0&&(b+="&"),b+=encodeURIComponent(a[c].name)+"="+encodeURIComponent(a[c].value);return b},_doGetRequest:function(a,b,c){var d=this._createXMLHttpRequest(),e=!0;d.open("get",a+(b.length>0?"?"+this._processParameters(b):""),e),e&&(d.onreadystatechange=function(){4===d.readyState&&c(d.status,d.responseText)}),d.send(null),e||c(d.status,d.responseText)},_doPostRequest:function(a,b,c,d,e){var f=this._createXMLHttpRequest(),g=!0;this._useMethodOverride&&"POST"!==a?(f.open("POST",b,g),f.setRequestHeader("x-http-method-override",a)):f.open(a,b,g),f.setRequestHeader("Content-type",d),CKEDITOR.env.webkit||(f.setRequestHeader("Content-length",c?c.length:0),f.setRequestHeader("Connection","close")),g&&(f.onreadystatechange=function(){4===f.readyState&&e(f.status,f.responseText)}),f.send(c),g||e(f.status,f.responseText)},_createXMLHttpRequest:function(){if(!CKEDITOR.env.ie||"file:"!==location.protocol){try{return new XMLHttpRequest}catch(a){}try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(a){}try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(a){}}return null}}}),DefaultConnector=CKEDITOR.tools.createClass({$:function(a){this._editor=a,this._leavingPage=!1,this._useWebSocket=!1,this._patchData={},this._ioHandler=a.config.coops.restIOHandler||new DefaultIOHandler(a),this._active=!1,this._pendingPatches=[],a.on("CoOPS:Join",this._onCoOpsJoin,this),a.on("CoOPS:BeforeSessionStart",this._onBeforeSessionStart,this,null,9999),a.on("destroy",this._onEditorDestroy,this),a.on("CoOPS:ContentPatch",this._onContentPatch,this),a.on("CoOPS:ContentRevert",this._onContentRevert,this),a.on("propertiesChange",this._onPropertiesChange,this),a.on("CoOPS:ExtensionPatch",this._onExtensionPatch,this)},proto:{getName:function(){return"default-connector"},_onCoOpsJoin:function(a){var b=a.data.protocolVersion,c=a.data.algorithms;a.editor;this._fileJoin(c,b,CKEDITOR.tools.bind(function(a,b,c){c?this._editor.fire("CoOPS:Error",{severity:"CRITICAL",message:"Failed to initiate collaboration session: "+c}):this._editor.fire("CoOPS:Joined",b)},this))},_onBeforeSessionStart:function(a){if(!a.data.isConnected()){var b=a.data.joinData;if(this._revisionNumber=b.revisionNumber,this._sessionId=b.sessionId,this._useWebSocket=!1,this._editor.config.coops.webSocket!==!1&&b.extensions.webSocket){var c=CKEDITOR.env.secure?b.extensions.webSocket.wss:b.extensions.webSocket.ws;if(c&&(this._webSocket=this._openWebSocket(c),this._webSocket)){switch(this._webSocket.onmessage=CKEDITOR.tools.bind(this._onWebSocketMessage,this),this._webSocket.onclose=CKEDITOR.tools.bind(this._onWebSocketClose,this),this._webSocket.readyState){case this._webSocket.CONNECTING:this._webSocket.onopen=CKEDITOR.tools.bind(this._onWebSocketOpen,this);break;case this._webSocket.OPEN:this._activate();break;default:this._editor.fire("CoOPS:Error",{severity:"CRITICAL",message:"WebSocket initialization failed."})}this._useWebSocket=!0}}this._useWebSocket||(this._activate(),"manual"!==this._editor.config.coops.restPolling?this._startUpdatePolling():this._editor.restCheckUpdates=CKEDITOR.tools.bind(function(){this._checkUpdates()},this)),window.onbeforeunload=CKEDITOR.tools.bind(this._onWindowBeforeUnload,this),this._editor.on("CoOPS:ConnectionLost",this._onConnectionLost,this),a.data.markConnected()}},_sendContentPatch:function(a,b){this._patchData[this._revisionNumber+1]?this._editor.fire("CoOPS:PatchRejected",{reason:"already sending a patch"}):(this._patchData[this._revisionNumber+1]={content:b},this._sendPatch(a,null,null))},_sendPropertiesPatch:function(a){this._patchData[this._revisionNumber+1]?this._editor.fire("CoOPS:PatchRejected",{reason:"already sending a patch"}):(this._patchData[this._revisionNumber+1]={properties:a},this._sendPatch(null,a,null))},_sendExtensionsPatch:function(a){this._patchData[this._revisionNumber+1]?this._editor.fire("CoOPS:PatchRejected",{reason:"already sending a patch"}):(this._patchData[this._revisionNumber+1]={extensions:a},this._sendPatch(null,null,a))},_onContentPatch:function(a){this._editor.config.coops.readOnly!==!0&&(this._active?this._sendContentPatch(a.data.patch,a.data.newContent):this._pendingPatches.push({type:"content",patch:a.data.patch,newContent:a.data.newContent}))},_onPropertiesChange:function(a){if(this._editor.config.coops.readOnly!==!0){for(var b=a.data.properties,c={},d=0,e=b.length;e>d;d++)c[b[d].property]=b[d].currentValue;this._active?this._sendPropertiesPatch(c):this._pendingPatches.push({type:"properties",properties:c})}},_onExtensionPatch:function(a){this._editor.config.coops.readOnly!==!0&&(this._active?this._sendExtensionsPatch(a.data.extensions):this._pendingPatches.push({type:"extensions",extensions:a.data.extensions}))},_onContentRevert:function(a){this._ioHandler.get(this._editor.config.coops.serverUrl,{},CKEDITOR.tools.bind(function(a,b,c){switch(a){case 200:var d=b.content;this._revisionNumber=b.revisionNumber,this._editor.fire("CoOPS:RevertedContentReceived",{content:d});break;default:this._editor.fire("CoOPS:Error",{severity:"SEVERE",message:"Failed to revert content"})}},this))},_onEditorDestroy:function(a){this._webSocket&&(this._webSocket.onclose=function(){},this._webSocket.close())},_onWindowBeforeUnload:function(a){this._leavingPage=!0,this._webSocket&&(this._webSocket.onclose=function(){},this._webSocket.close())},_tryReconnect:function(a){this._useWebSocket?(this._webSocket=this._openWebSocket(this._webSocket.url),CKEDITOR.tools.setTimeout(function(){this._webSocket.readyState===this._webSocket.OPEN?(this._webSocket.onmessage=CKEDITOR.tools.bind(this._onWebSocketMessage,this),this._webSocket.onclose=CKEDITOR.tools.bind(this._onWebSocketClose,this),this._editor.fire("CoOPS:Reconnect")):0>=a?this._editor.fire("CoOPS:Error",{severity:"CRITICAL",message:"Could not reconnect to server. Please try again later"}):this._tryReconnect(a-1)},this._editor.config.coops.reconnectTime||3e3,this)):CKEDITOR.tools.setTimeout(function(){this._ioHandler.get(this._editor.config.coops.serverUrl+"/update",[{name:"sessionId",value:this._sessionId},{name:"revisionNumber",value:this._revisionNumber}],CKEDITOR.tools.bind(function(b,c,d){200===b||204===b?(this._startUpdatePolling(),this._editor.fire("CoOPS:Reconnect")):0>=a?this._editor.fire("CoOPS:Error",{severity:"CRITICAL",message:"Could not reconnect to server. Please try again later"}):this._tryReconnect(a-1)},this))},this._editor.config.coops.reconnectTime||3e3,this)},_onConnectionLost:function(a){this._tryReconnect((this._editor.config.coops.maxReconnections||3)-1)},_onWebSocketOpen:function(a){this._activate()},_onWebSocketClose:function(a){this._leavingPage||this._editor.fire("CoOPS:ConnectionLost",{message:"Lost connection to server, trying to reconnect..."})},_onWebSocketMessage:function(a){var b=JSON.parse(a.data);if(b&&b.type)switch(b.type){case"update":b.data&&this._applyPatch(b.data);break;case"patchRejected":this._editor.fire("CoOPS:PatchRejected",{reason:b.data.message});break;case"patchError":this._editor.fire("CoOPS:Error",{severity:"SEVERE",message:"Received a patch error: "+b.data.message});break;default:this._editor.fire("CoOPS:Error",{severity:"CRITICAL",message:"Unknown WebSocket message "+b.type+" received"})}else this._editor.fire("CoOPS:Error",{severity:"WARNING",message:"Invalid WebSocket message received"})},_openWebSocket:function(a){return"undefined"!=typeof window.WebSocket?new WebSocket(a):"undefined"!=typeof window.MozWebSocket?new MozWebSocket(a):null},_activate:function(){if(!this._active){for(;this._pendingPatches.length;){var a=this._pendingPatches.shift();switch(a.type){case"content":this._sendContentPatch(a.patch,a.newContent);break;case"properties":this._sendPropertiesPatch(a.properties);break;case"extensions":this._sendExtensionsPatch(a.extensions)}}this._active=!0}},_sendPatch:function(a,b,c){this._useWebSocket?this._webSocket.send(JSON.stringify({type:"patch",data:{patch:a,properties:b,extensions:c,revisionNumber:this._revisionNumber,sessionId:this._sessionId}})):this._ioHandler.patch(this._editor.config.coops.serverUrl,{patch:a,properties:b,extensions:c,revisionNumber:this._revisionNumber,sessionId:this._sessionId},CKEDITOR.tools.bind(function(a,b,c){switch(a){case 204:break;case 409:this._editor.fire("CoOPS:PatchRejected",{reason:"Patch rejected"});break;default:this._editor.fire("CoOPS:Error",{severity:"SEVERE",message:"Patching failed on unknown error"})}},this)),this._editor.fire("CoOPS:PatchSent")},_fileJoin:function(a,b,c){for(var d=[],e=0,f=a.length;f>e;e++)d.push({name:"algorithm",value:a[e]});d.push({name:"protocolVersion",value:b});var g=this._editor.config.coops.serverUrl+"/join";this._ioHandler.get(g,d,c)},_startUpdatePolling:function(){this._pollUpdates()},_stopUpdatePolling:function(){this._timer&&clearTimeout(this._timer),this._timer=null},_checkUpdates:function(a){var b=this._editor.config.coops.serverUrl+"/update";this._ioHandler.get(b,[{name:"sessionId",value:this._sessionId},{name:"revisionNumber",value:this._revisionNumber}],CKEDITOR.tools.bind(function(b,c,d){0===b?(this._stopUpdatePolling(),this._leavingPage||this._editor.fire("CoOPS:ConnectionLost",{message:"Lost connection to server, trying to reconnect..."})):(200===b?this._applyPatches(c):204!==b&&304!==b&&this._editor.fire("CoOPS:Error",{severity:"WARNING",message:"Failed to synchronize collaborator changes from the server"}),a&&a())},this))},_pollUpdates:function(){this._checkUpdates(CKEDITOR.tools.bind(function(){this._timer=CKEDITOR.tools.setTimeout(this._pollUpdates,500,this)},this))},_applyPatches:function(a){var b=a.splice(0,1)[0];this._applyPatch(b,CKEDITOR.tools.bind(function(){a.length>0&&this._applyPatches(a)},this))},_applyPatch:function(a,b){if(this._sessionId!==a.sessionId)this._revisionNumber=a.revisionNumber,this._editor.fire("CoOPS:PatchReceived",{sessionId:a.sessionId,patch:a.patch,checksum:a.checksum,revisionNumber:a.revisionNumber,properties:a.properties,extensions:a.extensions})&&b&&b();else{this._revisionNumber=a.revisionNumber;var c=this._patchData[this._revisionNumber]||{};this._editor.fire("CoOPS:PatchAccepted",{revisionNumber:this._revisionNumber,content:c.content,properties:c.properties,extensions:c.extensions}),delete this._patchData[this._revisionNumber],b&&b()}}}}),CKEDITOR.plugins.add("coops-connector",{requires:["coops"],init:function(a){a.on("CoOPS:BeforeJoin",function(a){a.data.addConnector(new DefaultConnector(a.editor))})}})}).call(this);