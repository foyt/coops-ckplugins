/*! CKEditor plugin change - v0.1.1 - 2016-02-23
* https://github.com/foyt/coops-ckplugins
* Copyright (c) 2016 ; Licensed LGPL-v3 */
(function(){ChangeObserver=CKEDITOR.tools.createClass({$:function(a,b){this._editor=a,this._oldContent="",this._oldProperties={},this._paused=!1,this._propertyHandlers=b},proto:{getEditor:function(){return this._editor},checkChange:function(){if(!this._paused&&!this.getEditor().readOnly){for(var a=this._getEditorContent(),b=[],c=0,d=this._propertyHandlers.length;d>c;c++){var e=this._propertyHandlers[c].getName(),f=this._propertyHandlers[c].getValue(this._editor);this._oldProperties[e]!==f&&(b.push({property:e,oldValue:this._oldProperties[e],currentValue:f}),this._oldProperties[e]=f)}b.length>0&&this._editor.fire("propertiesChange",{properties:b}),this._oldContent!==a&&(this._oldContent=a,this._editor.fire("contentChange",{oldContent:this._oldContent,currentContent:a}))}},disconnect:function(){},start:function(){},reset:function(a){this._oldContent=a||this._getEditorContent(),this._oldProperties=this._getPropertyValues()},pause:function(){this._editor.fire("changeObserverPause")&&(this._paused=!0)},resume:function(){this._editor.fire("changeObserverResume")&&(this._paused=!1,this.checkChange())},_getEditorContent:function(){return this.getEditor().getData()},_getPropertyValues:function(){for(var a={},b=0,c=this._propertyHandlers.length;c>b;b++){var d=this._propertyHandlers[b].getName(),e=this._propertyHandlers[b].getValue(this._editor);a[d]=e}return a}}}),MutationChangeObserver=CKEDITOR.tools.createClass({base:ChangeObserver,$:function(a,b){this.base(a,b);var c=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver,d=this;this._observer=new c(function(a,b){CKEDITOR.tools.setTimeout(function(){this.checkChange()},0,d)})},proto:{start:function(){var a=this._editor.document.$;this._observer.observe(a,{attributes:!0,childList:!0,characterData:!0,subtree:!0})},disconnect:function(){this._observer.disconnect(),this._observer=void 0}}}),DOMSubtreeModifiedChangeObserver=CKEDITOR.tools.createClass({base:ChangeObserver,$:function(a,b){this.base(a,b);var c=this;this._domSubtreeModifiedListener=function(a){c._onDOMSubtreeModified(a)}},proto:{start:function(){this._editor.document.on("DOMSubtreeModified",this._domSubtreeModifiedListener)},disconnect:function(){this._editor.document.removeListener("DOMSubtreeModified",this._domSubtreeModifiedListener)},_onDOMSubtreeModified:function(a){CKEDITOR.tools.setTimeout(function(){this.checkChange()},0,this)}}}),PollingChangeObserver=CKEDITOR.tools.createClass({base:ChangeObserver,$:function(a,b){this.base(a,b),this._timer=null},proto:{start:function(){this._poll()},disconnect:function(){this._timer&&clearTimeout(this._timer),this._timer=null},_poll:function(a){this.checkChange(),this._timer=CKEDITOR.tools.setTimeout(this._poll,333,this)}}}),PropertyHandler=CKEDITOR.tools.createClass({$:function(){},proto:{getValue:function(a){throw new Error("not implemented")},setValue:function(a,b){throw new Error("not implemented")},getName:function(){throw new Error("not implemented")}}}),TitlePropertyHandler=CKEDITOR.tools.createClass({base:PropertyHandler,$:function(){},proto:{getValue:function(a){return a.document.getElementsByTag("title").getItem(0).data("cke-title")},setValue:function(a,b){a.document.getElementsByTag("title").getItem(0).data("cke-title",b)},getName:function(){return"title"}}}),LangDirPropertyHandler=CKEDITOR.tools.createClass({base:PropertyHandler,$:function(){},proto:{getValue:function(a){return a.document.getBody().getDirection()},setValue:function(a,b){var c=a.document.getBody();b?c.setAttribute("dir",b):c.removeAttribute("dir"),c.removeStyle("direction")},getName:function(){return"langDir"}}}),LangCodePropertyHandler=CKEDITOR.tools.createClass({base:PropertyHandler,$:function(){},proto:{getValue:function(a){var b=a.document.getDocumentElement(),c=b.getAttribute("xml:lang");return c?c:(c=b.getAttribute("lang"),c?c:null)},setValue:function(a,b){var c=a.document.getDocumentElement();b?c.setAttributes({"xml:lang":b,lang:b}):c.removeAttributes({"xml:lang":1,lang:1})},getName:function(){return"langCode"}}}),CharsetPropertyHandler=CKEDITOR.tools.createClass({base:PropertyHandler,$:function(){},proto:{getValue:function(a){for(var b=a.document.getHead().getElementsByTag("meta"),c=0,d=b.count();d>c;c++){var e=b.getItem(c);if("content-type"===e.getAttribute("http-equiv")){var f=e.getAttribute("content");return f.match(/charset=[^=]+$/)?f.substring(f.indexOf("=")+1):null}}},setValue:function(a,b){for(var c,d=b?"text/html; charset="+b:null,e=a.document.getHead().getElementsByTag("meta"),f=0,g=e.count();g>f;f++)if(c=e.getItem(f),"content-type"===c.getAttribute("http-equiv")){d?c.setAttribute("content",d):c.remove();break}d&&(c=new CKEDITOR.dom.element("meta",a.document),c.setAttribute("http-equiv","content-type"),c.setAttribute("content",d),a.document.getHead().append(c))},getName:function(){return"charset"}}}),DocTypePropertyHandler=CKEDITOR.tools.createClass({base:PropertyHandler,$:function(){},proto:{getValue:function(a){return a.docType},setValue:function(a,b){a.docType=b},getName:function(){return"docType"}}}),TextColorPropertyHandler=CKEDITOR.tools.createClass({base:PropertyHandler,$:function(){},proto:{getValue:function(a){return a.document.getBody().getComputedStyle("color")},setValue:function(a,b){var c=a.document.getBody();c.removeAttribute("text"),b?c.setStyle("color",b):c.removeStyle("color")},getName:function(){return"textColor"}}}),BackgroundColorPropertyHandler=CKEDITOR.tools.createClass({base:PropertyHandler,$:function(){},proto:{getValue:function(a){return a.document.getBody().getComputedStyle("background-color")},setValue:function(a,b){var c=a.document.getBody();c.removeAttribute("bgcolor"),b?c.setStyle("background-color",b):c.removeStyle("background-color")},getName:function(){return"backgroundColor"}}}),BackgroundImagePropertyHandler=CKEDITOR.tools.createClass({base:PropertyHandler,$:function(){},proto:{getValue:function(a){return a.document.getBody().getComputedStyle("background-image")},setValue:function(a,b){var c=a.document.getBody();c.removeAttribute("bgcolor"),b?c.setStyle("background-image",b):c.removeStyle("background-image")},getName:function(){return"backgroundImage"}}}),BackgroundAttachmentPropertyHandler=CKEDITOR.tools.createClass({base:PropertyHandler,$:function(){},proto:{getValue:function(a){return a.document.getBody().getComputedStyle("background-attachment")},setValue:function(a,b){var c=a.document.getBody();b?c.setStyle("background-attachment",b):c.removeStyle("background-attachment")},getName:function(){return"backgroundAttachment"}}}),PageMarginPropertyHandler=CKEDITOR.tools.createClass({base:PropertyHandler,$:function(a,b){this._name=a,this._property=b},proto:{getValue:function(a){var b=a.document.getBody();return b.getStyle("margin-"+this._property)||b.getAttribute("margin"+this._property)},setValue:function(a,b){var c=a.document.getBody();c.removeAttribute("margin"+this._property),b?c.setStyle("margin-"+this._property,b):c.removeStyle("margin-"+this._property)},getName:function(){return this._name}}}),MetaPropertyHandler=CKEDITOR.tools.createClass({base:PropertyHandler,$:function(a,b){this._name=a,this._property=b},proto:{getValue:function(a){for(var b=a.document.getHead().getElementsByTag("meta"),c=0,d=b.count();d>c;c++){var e=b.getItem(c);if(e.getAttribute("name")===this._property)return e.getAttribute("content")}},setValue:function(a,b){for(var c,d=a.document.getHead().getElementsByTag("meta"),e=0,f=d.count();f>e;e++)if(c=d.getItem(e),c.getAttribute("name")===this._property)return void c.setAttribute("content",b);b&&(c=new CKEDITOR.dom.element("meta",a.document),c.setAttribute("name",this._property),c.setAttribute("content",b),a.document.getHead().append(c))},getName:function(){return this._name}}}),CKEDITOR.plugins.add("change",{requires:[],init:function(a){CKEDITOR.tools.extend(CKEDITOR.editor.prototype,{getChangeObserver:function(){return this._changeObserver}});var b=a.config.fullPage?[new TitlePropertyHandler,new LangDirPropertyHandler,new LangCodePropertyHandler,new CharsetPropertyHandler,new DocTypePropertyHandler,new TextColorPropertyHandler,new BackgroundColorPropertyHandler,new BackgroundImagePropertyHandler,new BackgroundAttachmentPropertyHandler,new PageMarginPropertyHandler("pageMarginLeft","left"),new PageMarginPropertyHandler("pageMarginTop","top"),new PageMarginPropertyHandler("pageMarginRight","right"),new PageMarginPropertyHandler("pageMarginBottom","bottom"),new MetaPropertyHandler("metaKeywords","keywords"),new MetaPropertyHandler("metaDescription","description"),new MetaPropertyHandler("metaAuthor","author"),new MetaPropertyHandler("metaCopyright","copyright")]:[],c=null;CKEDITOR.env.ie||CKEDITOR.env.edge||"function"==typeof(window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver)&&(c=new MutationChangeObserver(a,b)),c||(c=CKEDITOR.env.ie&&9===CKEDITOR.env.version?new DOMSubtreeModifiedChangeObserver(a,b):new PollingChangeObserver(a,b)),a._changeObserver=c,a.on("instanceReady",function(){this.getChangeObserver().start()}),a.on("beforePaste",function(a){this.getChangeObserver().pause()}),a.on("paste",function(a){this.getChangeObserver().resume()},a,null,99999)}})}).call(this);