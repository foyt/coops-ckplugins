/*! CKEditor plugin coops - v0.1.2 - 2016-05-30
* https://github.com/foyt/coops-ckplugins
* Copyright (c) 2016 ; Licensed LGPL-v3 */
(function(){var a="1.0.0";CoOps=CKEDITOR.tools.createClass({$:function(a){this._editor=a,this._savedContent=null,this._rnrTimeout=null,this._editor.config.coops.readOnly!==!0&&(this._editor.on("contentChange",this._onContentChange,this),this._editor.on("propertiesChange",this._onPropertiesChange,this)),this._editor.on("CoOPS:SessionStart",this._onSessionStart,this),this._editor.on("CoOPS:ContentPatch",this._onContentPatch,this),this._editor.on("CoOPS:ContentRevert",this._onContentRevert,this),this._editor.on("CoOPS:PatchSent",this._onPatchSent,this),this._editor.on("CoOPS:PatchAccepted",this._onPatchAccepted,this),this._editor.on("CoOPS:PatchMerged",this._onPatchMerged,this),this._editor.on("CoOPS:PatchRejected",this._onPatchRejected,this),this._editor.on("CoOPS:ContentReverted",this._onContentReverted,this),this._editor.on("CoOPS:PatchApplied",this._onPatchApplied,this),this._editor.on("CoOPS:Joined",this._onJoined,this),this._editor.on("CoOPS:ConnectionLost",this._onConnectionLost,this),this._editor.on("CoOPS:Reconnect",this._onReconnect,this)},proto:{getEditor:function(){return this._editor},isLocallyChanged:function(){return this.getUnsavedContent()!==this._savedContent},getUnsavedContent:function(){return this._editor.getData().replace(/\n/g,"")},getSavedContent:function(){return this._savedContent},setSavedContent:function(a){this._savedContent=a},log:function(a){this._editor.config.coops.log?this._editor.config.coops.log(a):window.console&&console.log(a)},_resetAndResume:function(a){this._rnrTimeout&&(clearTimeout(this._rnrTimeout),this._rnrTimeout=null),this._rnrTimeout=CKEDITOR.tools.setTimeout(function(){var a=this.getUnsavedContent();this._editor.getChangeObserver().reset(a),this._editor.getChangeObserver().resume(),this.isLocallyChanged()&&this._editor.fire("CoOPS:ContentDirty",{unsavedContent:a,savedContent:this.getSavedContent()}),this._rnrTimeout=null},a||0,this)},_onContentChange:function(a){this.isLocallyChanged()&&this._editor.fire("CoOPS:ContentDirty",{unsavedContent:this.getUnsavedContent(),savedContent:this.getSavedContent()})},_onSessionStart:function(a){this.setSavedContent(a.data.content)},_onContentPatch:function(a){this._editor.getChangeObserver().pause()},_onContentRevert:function(a){this._editor.getChangeObserver().pause()},_onPropertiesChange:function(a){this._editor.getChangeObserver().pause()},_onPatchSent:function(a){this._editor.getChangeObserver().pause()},_onPatchAccepted:function(a){void 0!==a.data.content&&this.setSavedContent(a.data.content),this._resetAndResume(100)},_onPatchMerged:function(a){this.setSavedContent(a.data.patched),this._resetAndResume()},_onPatchRejected:function(a){this._resetAndResume(1e3)},_onContentReverted:function(a){this.setSavedContent(a.data.content),this._resetAndResume()},_onPatchApplied:function(a){this.setSavedContent(a.data.content)},_onJoined:function(a){var b=a.data.content;this._editor.getChangeObserver().pause(),this._editor.getSelection().removeAllRanges();var c=!1,d={joinData:a.data,isConnected:function(){return c},markConnected:function(){c=!0}};this._editor.fire("CoOPS:BeforeSessionStart",d),d.isConnected()?this._editor.setData(b,function(){this.config.coops.readOnly!==!0&&(this.getChangeObserver().reset(b),this.getChangeObserver().resume(),this.setReadOnly(!1)),this.fire("CoOPS:SessionStart",{content:b})}):this._editor.fire("CoOPS:Error",{severity:"CRITICAL",message:"Could not connect to CoOPS Server"})},_onConnectionLost:function(a){this._editor.setReadOnly(!0)},_onReconnect:function(a){this._editor.config.coops.readOnly!==!0&&this._editor.setReadOnly(!1)}}}),CKEDITOR.plugins.add("coops",{requires:["change"],onLoad:function(){CKEDITOR.tools.extend(CKEDITOR.editor.prototype,{getCoOps:function(){return this._coOps}})},init:function(b){b.on("instanceReady",function(b){this._coOps=new CoOps(this);var c=new Array,d=new Array,e={addAlgorithm:function(a){c.push(a)},addConnector:function(a){d.push(a)}};this.fire("CoOPS:BeforeJoin",e);for(var f=new Array,g=0,h=c.length;h>g;g++)f.push(c[g].getName());this.fire("CoOPS:Join",{protocolVersion:a,algorithms:f})})}})}).call(this);