/*! CKEditor plugin coops-cursors - v0.1.2 - 2016-05-30
* https://github.com/foyt/coops-ckplugins
* Copyright (c) 2016 ; Licensed LGPL-v3 */
(function(){CoOpsCursors=CKEDITOR.tools.createClass({$:function(a){this._editor=a,this._lastDispatched=null,this._lastSaved=null,this._colorIterator=0,this._svgAnimateIterator=0,this._colors=this._createCursorColors(64),this._clientSelections={},this._editor.on("CoOPS:SessionStart",this._onSessionStart,this)},proto:{_onSessionStart:function(){this._editor.on("selectionChange",this._onSelectionChange,this),this._editor.on("CoOPS:PatchReceived",this._onPatchReceived,this,null,9999),this._editor.on("CoOPS:PatchRejected",this._onPatchRejected,this,null,9999),this._editor.on("CoOPS:PatchAccepted",this._onPatchAccepted,this,null,9999),this._editor.on("CoOPS:PatchApplied",this._onPatchApplied,this,null,9999),this._editor.on("CoOPS:PatchMerged",this._onPatchMerged,this,null,9999),this._editor.document.on("mouseup",this._onDocumentMouseUp,this),this._editor.on("key",this._onEditorKey,this)},_onDocumentMouseUp:function(a){this._checkSelection()},_onEditorKey:function(a){this._checkSelection()},_onSelectionChange:function(a){this._checkSelection(),this._dispatchSelectionChanges(this._createDispatchableSelection(this._editor.getSelection()))},_onPatchRejected:function(a){this._lastDispatched=null},_onPatchAccepted:function(a){a.data.extensions&&a.data.extensions.ckcur&&(this._lastSaved=this._lastDispatched),CKEDITOR.tools.setTimeout(function(){this._checkSelection(),this._dispatchSelectionChanges(this._createDispatchableSelection(this._editor.getSelection()))},2e3,this)},_onPatchReceived:function(a){var b=a.data,c=a.data.sessionId,d=this._clientSelections[c];if(d?d.ranges=[]:d=this._clientSelections[c]={color:this._nextColor(),ranges:[]},b.extensions&&b.extensions.ckcur&&b.extensions.ckcur.selections)for(var e=b.extensions.ckcur.selections,f=0,g=e.length;g>f;f++){var h=e[f],i=this._findNodeByXPath(h.startContainer),j=h.startOffset,k=h.endOffset;try{var l=new CKEDITOR.dom.range(this._editor.document);if(l.setStart(i,j),h.collapsed)l.setEnd(i,k);else{var m=this._findNodeByXPath(h.endContainer);l.setEnd(m,k)}d.ranges.push(l)}catch(n){throw n}}this._drawClientSelections(),this._checkSelection(),this._dispatchSelectionChanges(this._createDispatchableSelection(this._editor.getSelection()))},_onPatchApplied:function(a){this._drawClientSelections()},_onPatchMerged:function(a){this._drawClientSelections()},_createDispatchableSelection:function(a){var b=null;if(a){var c=a.getRanges();if(c.length>0){b=[];for(var d=0,e=c.length;e>d;d++){var f=c[d],g=this._createXPath(f.startContainer);if(f.collapsed)b.push({collapsed:f.collapsed,startContainer:g,startOffset:f.startOffset,endOffset:f.endOffset});else{var h=this._createXPath(f.endContainer);b.push({collapsed:f.collapsed,startContainer:g,startOffset:f.startOffset,endContainer:h,endOffset:f.endOffset})}}}}return b},_dispatchSelectionChanges:function(a){!this._editor.readOnly&&a&&(this._lastDispatched&&this._dispatchablesEqual(this._lastDispatched,a)||this._lastSaved&&this._dispatchablesEqual(this._lastSaved,a)||(this._editor.fire("CoOPS:ExtensionPatch",{extensions:{ckcur:{selections:a}}}),this._lastDispatched=a))},_dispatchablesEqual:function(a,b){if(a.length===b.length){for(var c=0,d=a.length;d>c;c++)if(a[c].startOffset!==b[c].startOffset||a[c].endOffset!==b[c].endOffset||a[c].startContainer!==b[c].startContainer||a[c].collapsed!==b[c].collapsed||a[c].endContainer!==b[c].endContainer)return!1;return!0}return!1},_checkSelection:function(){this._editor.forceNextSelectionCheck(),this._editor.selectionChange()},_cssColor:function(a,b){return 1===b?"#"+a[0].toString(16)+a[1].toString(16)+a[2].toString(16):"rgba("+a.join(",")+","+b+")"},_nextColor:function(){return this._colorIterator=(this._colorIterator+1)%this._colors.length,this._colors[this._colorIterator]},_createCursorColors:function(a){for(var b=[],c=255;c>=0;c-=a)for(var d=255;d>=0;d-=a)for(var e=255;e>=0;e-=a)c=Math.max(c,0),d=Math.max(d,0),e=Math.max(e,0),0===c&&0===d&&0===e||255===c&&255===d&&255===e||b.push([c,d,e]);return b.sort(function(a,b){var c=Math.abs(a[0]-a[1])+Math.abs(a[1]-a[2])+Math.abs(a[0]-a[2]),d=Math.abs(b[0]-b[1])+Math.abs(b[1]-b[2])+Math.abs(b[0]-b[2]);return d-c}),b},_findNodeByXPath:function(a){var b=this._editor.document.$,c=b.evaluate(a,b,null,XPathResult.ANY_TYPE,null);return new CKEDITOR.dom.node(c.iterateNext())},_createXPath:function(a){if(a.type===CKEDITOR.NODE_DOCUMENT)return"/";var b=a.getParent();return b?this._createXPath(b)+"/node()["+(a.getIndex(!0)+1)+"]":"/node()["+(a.getIndex(!0)+1)+"]"},_createBoxes:function(a){var b=[];try{var c=this._editor.document.$.createRange();if(a.collapsed){if(a.startContainer.type!==CKEDITOR.NODE_ELEMENT||a.startOffset!==a.endOffset||a.startContainer.getChild(a.endOffset))c.setStart(a.startContainer.$,a.startOffset),c.setEnd(a.startContainer.$,a.endOffset);else{var d=new CKEDITOR.dom.range(a.startContainer);d.selectNodeContents(a.startContainer);var e=new CKEDITOR.dom.walker(d);e.evaluator=function(a){return a.type===CKEDITOR.NODE_TEXT};var f=e.lastForward();if(!f)return[];c.setStart(f.$,f.getLength()),c.setEnd(f.$,f.getLength())}var g=c.getBoundingClientRect(),h=this._editor.window.getScrollPosition();b.push({top:Math.floor(g.top)+h.y,left:Math.floor(g.left)+h.x,width:1,height:Math.ceil(g.height)})}else{var e=new CKEDITOR.dom.walker(a);e.evaluator=function(a){return a.type===CKEDITOR.NODE_TEXT};for(var i;i=e.next();){i.equals(a.startContainer)?c.setStart(i.$,a.startOffset):c.setStartBefore(i.$),i.equals(a.endContainer)?c.setEnd(i.$,a.endOffset):c.setEndAfter(i.$);var g=c.getBoundingClientRect(),h=this._editor.window.getScrollPosition();g.height>0&&g.width>0&&b.push({top:Math.floor(g.top)+h.y,left:Math.floor(g.left)+h.x,width:Math.ceil(g.width),height:Math.ceil(g.height)})}}}catch(j){this._editor.getCoOps().log("Could not create selection boxes:"+j)}return b},_svgRect:function(a,b,c,d,e,f,g){var h='<rect x="'+a+'" y="'+b+'" width="'+c+'" height="'+d+'" style="fill:'+this._cssColor(f,g)+'">';if(e){var i=String(this._svgAnimateIterator++);h+='<animate id="o'+i+'" attributeName="opacity" from="1" to="0" dur="0.5s" begin="0s;i'+i+'.end" />',h+='<animate id="i'+i+'" attributeName="opacity" from="0" to="1" dur="0.5s" begin="o'+i+'.end" />'}return h+="</rect>"},_drawClientSelections:function(){for(var a=CKEDITOR.tools.objectKeys(this._clientSelections),b=[],c=0,d=a.length;d>c;c++){var e=this._clientSelections[a[c]];for(k=e.ranges.length-1;k>=0;k--){var f=e.ranges[k];f.startContainer&&f.startContainer.$?b.push({color:e.color,boxes:this._createBoxes(e.ranges[k])}):e.ranges.splice(k,1)}}var g=(this._editor.config.coops.cursors||{}).drawMode;switch(g||(g="SVG"),g){case"SVG":for(var h=this._boxedSelectionsDimensions(b),i="<svg xmlns='http://www.w3.org/2000/svg' width='"+h.width+"' height='"+h.height+"'>",c=0,d=b.length;d>c;c++)for(var j=b[c],k=0,l=j.boxes.length;l>k;k++){var m=j.boxes[k];1===m.width?(i+=this._svgRect(m.left,m.top,m.width,m.height,!0,j.color,1),i+=this._svgRect(m.left-2,m.top-5,5,5,!0,j.color,1)):i+=this._svgRect(m.left,m.top,m.width,m.height,!1,j.color,.5)}i+="</svg>",this._editor.document.getBody().setStyles({"background-image":"url(data:image/svg+xml;base64,"+btoa(i)+")","background-repeat":"no-repeat","background-position":"top left"});break;case"CANVAS":var n=this._boxedSelectionsDimensions(b);this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.height=n.height,this._canvas.width=n.width;for(var o=this._canvas.getContext("2d"),c=0,d=b.length;d>c;c++){var j=b[c];o.fillStyle=j.color;for(var k=0,l=j.boxes.length;l>k;k++){var m=j.boxes[k];o.fillRect(m.left,m.top,m.width,m.height)}}this._editor.document.getBody().setStyles({"background-image":canvasHeight>0&&canvasWidth>0?"url("+this._canvas.toDataURL()+")":"none","background-repeat":"no-repeat","background-position":"top left"})}},_boxedSelectionsDimensions:function(a){for(var b=0,c=0,d=0,e=a.length;e>d;d++)for(var f=a[d],g=0,h=f.boxes.length;h>g;g++){var i=f.boxes[g];b=Math.max(b,i.top+i.height),c=Math.max(c,i.left+i.width)}return{width:c,height:b}},_drawBoxes:function(a){var b=document.createElement("canvas");if(a.length>0){for(var c=0,d=0,e=0,f=a.length;f>e;e++){var g=a[e];c=Math.max(c,Math.ceil(g.top+g.height)),d=Math.max(d,Math.ceil(g.left+g.width))}b.height=c,b.width=d;for(var h=b.getContext("2d"),i=0,j=a.length;j>i;i++)h.fillStyle=a[i].color,h.fillRect(Math.floor(a[i].left),Math.floor(a[i].top),Math.ceil(a[i].width),Math.ceil(a[i].height))}this._editor.document.getBody().setStyles({"background-image":"url("+b.toDataURL()+")","background-repeat":"no-repeat","background-position":"top left"})}}}),CKEDITOR.plugins.add("coops-cursors",{requires:["coops"],init:function(a){a.on("CoOPS:BeforeJoin",function(a){new CoOpsCursors(a.editor)})}})}).call(this);